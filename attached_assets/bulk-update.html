<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Budget Bulk Update</title>
  <style>
    .editable-table {
      border-collapse: collapse;
      width: 100%;
      margin: 20px 0;
    }
    .editable-table th, .editable-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .editable-table th {
      background-color: #2196F3;
      color: white;
      position: sticky;
      top: 0;
      z-index: 1;
      padding: 12px 8px;
      font-size: 14px;
      font-weight: bold;
      text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
      white-space: nowrap;
      border: 1px solid #1976D2;
    }
    .editable-table td[contenteditable="true"]:focus {
      outline: 2px solid #4CAF50;
      background-color: #f9f9f9;
    }
    .button {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    .button:hover {
      background-color: #45a049;
    }
    .container {
      margin: 20px;
      max-height: 80vh;
      overflow: auto;
    }
    .actions {
      position: sticky;
      top: 0;
      background: white;
      padding: 10px 0;
      z-index: 2;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="actions">
      <a href="/catalog" class="button" style="background-color: #2196F3;">Back to Catalog</a>
      <button onclick="loadProjects()" class="button" style="background-color: #FF9800;">Load Projects</button>
      <button onclick="addRow()" class="button">Add Row</button>
      <button onclick="saveChanges()" class="button">Save Changes</button>
      <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleCsvUpload(event)">
      <button onclick="document.getElementById('csvFile').click()" class="button" style="background-color: #9C27B0;">Upload CSV</button>
    </div>

    <script type="module">
    import { CsvUploadManager } from '/catalog/managers/CsvUploadManager.js';
    import { ErrorHandler } from '/utils/errorHandler.js';
    
    window.handleCsvUpload = async function(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Reset file input
      event.target.value = '';
      
      const csvUploadManager = new CsvUploadManager();
      try {
        if (file.size === 0) {
          throw new Error('Selected file is empty');
        }

        const result = await csvUploadManager.handleFileUpload(file);
        if (result.success) {
          console.log('Upload successful:', result.data);
          await loadProjects(); // Reload the table with new data
        } else {
          throw new Error(result.error || 'Upload failed');
        }
      } catch (error) {
        console.error('CSV upload error:', error);
        ErrorHandler.showError(error.message || 'Failed to upload file');
      }
    }
    </script>

    <table id="budgetTable" class="editable-table">
      <thead>
        <tr>
          <th>NA853</th>
          <th>Προϋπολογισμός</th>
          <th>Ετήσια Πίστωση</th>
          <th>Q1</th>
          <th>Q2</th>
          <th>Q3</th>
          <th>Q4</th>
          <th>Κατανομές Έτους</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    async function loadProjects() {
      try {
        // Fetch all projects without pagination
        const response = await fetch('/api/catalog?limit=1000', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          }
        });
        const result = await response.json();

        // Fetch budget data
        const budgetResponse = await fetch('/api/budget/all', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          }
        });

        if (!budgetResponse.ok) {
          throw new Error(`Budget fetch failed: ${budgetResponse.status}`);
        }

        let budgetData = await budgetResponse.json();

        // Ensure budgetData is an array
        if (!Array.isArray(budgetData)) {
          budgetData = [];
          console.error('Invalid budget data format received');
        }

        console.log('Loaded projects:', result.data.length);
        console.log('Loaded budget data:', budgetData.length);

        if (!budgetData.length) {
          console.warn('No budget data found - this may indicate a database issue');
        }

        const tbody = document.querySelector('#budgetTable tbody');
        tbody.innerHTML = '';

        result.data.forEach(project => {
          const tr = document.createElement('tr');
          const budget = budgetData.find(b => b.na853 === project.na853) || {};

          // Define cell values with placeholders
          const cells = [
            { value: project.na853 || '', editable: false },
            { value: budget.proip || '', editable: true },
            { value: budget.ethsia_pistosi || '', editable: true },
            { value: budget.q1 || '', editable: true },
            { value: budget.q2 || '', editable: true },
            { value: budget.q3 || '', editable: true },
            { value: budget.q4 || '', editable: true },
            { value: budget.katanomes_etous || '', editable: true }
          ];

          cells.forEach(cell => {
            const td = document.createElement('td');
            td.contentEditable = cell.editable;
            td.textContent = cell.value;
            td.setAttribute('data-placeholder', cell.value);
            td.title = cell.value;
            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        });
      } catch (error) {
        console.error('Error loading projects:', error);
        alert('Failed to load projects');
      }
    }

    function addRow() {
      const tbody = document.querySelector('#budgetTable tbody');
      const tr = document.createElement('tr');
      for (let i = 0; i < 8; i++) {
        const td = document.createElement('td');
        td.contentEditable = true;
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }

    function validateNumber(value) {
      const num = parseFloat(value);
      return isNaN(num) ? 0 : num;
    }

    async function saveChanges() {
      try {
        const rows = Array.from(document.querySelectorAll('#budgetTable tbody tr'));
        const data = rows
        .map(row => {
          const cells = Array.from(row.cells);
          if (!cells[0].textContent.trim()) return null;
          return {
            na853: cells[0].textContent.trim(),
            proip: parseFloat(cells[1].textContent) || 0,
            ethsia_pistosi: parseFloat(cells[2].textContent) || 0,
            q1: parseFloat(cells[3].textContent) || 0,
            q2: parseFloat(cells[4].textContent) || 0,
            q3: parseFloat(cells[5].textContent) || 0,
            q4: parseFloat(cells[6].textContent) || 0,
            katanomes_etous: parseFloat(cells[7].textContent) || 0
          };
        })
        .filter(row => row !== null);
        
        const response = await fetch('/api/budget/bulk-update', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          },
          body: JSON.stringify({ updates: data })
        });

        const result = await response.json();
        alert(result.status === 'success' ? 
          `Updated ${result.results.success.length} records` : 
          'Error updating records');
      } catch (error) {
        console.error('Error saving changes:', error);
        alert('Failed to save changes: ' + (error.message || 'Unknown error'));
      }
    }

          

    // Load projects when page loads
    document.addEventListener('DOMContentLoaded', loadProjects);
  </script>
</body>
</html>